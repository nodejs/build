FROM registry.access.redhat.com/ubi8:8.1

ENV LC_ALL C
ENV USER {{ server_user }}
ENV JOBS {{ server_jobs | default(ansible_processor_vcpus) }}
ENV SHELL /bin/bash
ENV PATH /usr/lib64/ccache:/usr/lib/ccache:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ENV NODE_COMMON_PIPE /home/{{ server_user }}/test.pipe
ENV NODE_TEST_DIR /home/{{ server_user }}/tmp
ENV OSTYPE linux-gnu
ENV OSVARIANT docker
ENV DESTCPU {{ arch }}
ENV ARCH {{ arch }}

# Register with RHEL subscription to be able to install older versions of packages.
COPY secrets.txt /secrets.txt
# ccache is not in the default repositories so get it from EPEL 8.
RUN chmod u+x /secrets.txt && . /secrets.txt \
    && sed -i 's/\(def in_container():\)/\1\n    return False/g' /usr/lib64/python*/*-packages/rhsm/config.py \
    && subscription-manager register --org $RH_ORG --activationkey $RH_ACTIVATION_KEY \
    && rm -rf /secrets.txt \
    && dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm \
    && dnf update -y \
    && dnf install -y \
      ccache \
      gcc-c++ \
      gcc-toolset-10 \
      gcc-toolset-12 \
      gcc-toolset-14-libatomic-devel \
      git \
      java-17-openjdk-headless \
      llvm-toolset-19.1.7 \
      make \
      python3.12 \
      python3.12-pip \
      openssl-devel \
      procps-ng \
      rust-toolset-1.84.1 \
    && dnf clean all \
    && subscription-manager unregister

RUN groupadd -r -g {{ server_user_gid.stdout_lines[0] }} {{ server_user }} \
    && adduser -r -m -d /home/{{ server_user }}/ \
      -g {{ server_user_gid.stdout_lines[0] }} \
      -u {{ server_user_uid.stdout_lines[0] }} {{ server_user }} 

# Relax crypto policies to allow Node.js tests to pass
RUN update-crypto-policies --set LEGACY

VOLUME /home/{{ server_user }}/ /home/{{ server_user }}/.ccache

RUN pip3 install tap2junit=={{ tap2junit_version }}

USER iojs:iojs

ENV CCACHE_TEMPDIR /home/iojs/.ccache/{{ item.name }}

CMD cd /home/iojs \
  && curl https://ci.nodejs.org/jnlpJars/agent.jar -O \
  && java -Xmx{{ server_ram|default('128m') }} \
          -jar /home/{{ server_user }}/agent.jar \
          -url {{ jenkins_url }} \
          -name {{ item.name }} \
          -secret {{ item.secret }}
